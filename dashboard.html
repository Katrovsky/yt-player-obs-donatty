<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YouTube Player</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:        #0f0f11;
      --surface:   #17171a;
      --surface2:  #1e1e22;
      --surface3:  #26262c;
      --border:    #2a2a30;
      --border2:   #333339;
      --txt:       #e8e8ed;
      --txt2:      #7e7e8f;
      --txt3:      #4a4a58;
      --accent:    #5b6af0;
      --accent2:   #3d4ed4;
      --green:     #34c77b;
      --gold:      #f0b429;
      --red:       #f04f4f;
      --amber:     #f59e0b;
      --radius:    8px;
      --radius-lg: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--txt);
      font-family: 'DM Sans', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    .header {
      height: 52px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      flex-shrink: 0;
    }
    .header-logo {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--txt);
    }
    .header-logo span { color: var(--accent); }
    .header-sep { flex: 1; }
    .conn-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--txt3);
      transition: background 0.3s;
    }
    .conn-dot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .conn-label { font-size: 0.75rem; color: var(--txt2); font-family: 'DM Mono', monospace; }

    /* ── Layout ── */
    .layout {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    /* ── Sidebar shared ── */
    .sidebar {
      width: 280px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }
    .sidebar-title {
      height: 44px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--txt3);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      scrollbar-width: thin;
      scrollbar-color: var(--border2) transparent;
    }

    /* ── Center ── */
    .center {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* ── Now Playing ── */
    .now-playing {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 20px 24px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-shrink: 0;
    }
    .np-thumb {
      width: 72px;
      height: 54px;
      border-radius: 6px;
      background: var(--surface3);
      object-fit: cover;
      flex-shrink: 0;
      display: none;
    }
    .np-thumb.visible { display: block; }
    .np-thumb-placeholder {
      width: 72px;
      height: 54px;
      border-radius: 6px;
      background: var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .np-thumb-placeholder svg { opacity: 0.2; }
    .np-info { flex: 1; min-width: 0; }
    .np-eyebrow {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--txt3);
      margin-bottom: 4px;
    }
    .np-title {
      font-size: 1rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .np-title a { color: var(--txt); text-decoration: none; }
    .np-title a:hover { color: var(--accent); }
    .np-by { font-size: 0.8rem; color: var(--txt2); }
    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .ctrl {
      width: 36px; height: 36px;
      border-radius: var(--radius);
      border: 1px solid var(--border2);
      background: var(--surface2);
      color: var(--txt);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s, transform 0.1s;
    }
    .ctrl:hover { border-color: var(--accent); background: var(--surface3); }
    .ctrl:active { transform: scale(0.93); }
    .ctrl.play-btn {
      width: 44px; height: 44px;
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .ctrl.play-btn:hover { background: var(--accent2); border-color: var(--accent2); }
    .ctrl.play-btn.paused { background: var(--amber); border-color: var(--amber); }
    .ctrl.play-btn.paused:hover { background: #d97706; border-color: #d97706; }

    /* ── Queue section ── */
    .queue-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .queue-header {
      height: 44px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
      flex-shrink: 0;
    }
    .queue-header-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--txt3);
    }
    .queue-stats {
      display: flex;
      gap: 10px;
      margin-left: 4px;
    }
    .qstat {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.72rem;
      color: var(--txt2);
      font-family: 'DM Mono', monospace;
    }
    .qstat-num { color: var(--gold); font-weight: 500; }
    .qstat-sep { color: var(--txt3); }
    .header-sep-flex { flex: 1; }
    .btn-clear {
      height: 26px;
      padding: 0 10px;
      border-radius: 5px;
      background: transparent;
      border: 1px solid var(--border2);
      color: var(--txt2);
      font-size: 0.72rem;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: border-color 0.15s, color 0.15s;
    }
    .btn-clear:hover { border-color: var(--red); color: var(--red); }

    .queue-meta-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 8px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.72rem;
      color: var(--txt2);
    }
    .meta-label { color: var(--txt3); }
    .meta-val { font-family: 'DM Mono', monospace; font-weight: 500; }
    .meta-dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--green);
    }
    .meta-dot.off { background: var(--txt3); }

    .queue-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--border2) transparent;
    }

    .q-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: var(--radius);
      margin-bottom: 3px;
      border: 1px solid transparent;
      transition: background 0.15s, border-color 0.15s;
      position: relative;
    }
    .q-item:hover { background: var(--surface2); border-color: var(--border); }
    .q-item.current {
      background: color-mix(in srgb, var(--green) 8%, var(--surface2));
      border-color: color-mix(in srgb, var(--green) 30%, transparent);
    }
    .q-item.paid { border-left: 2px solid var(--gold); }
    .q-item.playlist-track { border-left: 2px solid var(--accent); }
    .q-item.past { opacity: 0.35; }

    .q-num {
      font-size: 0.7rem;
      color: var(--txt3);
      font-family: 'DM Mono', monospace;
      width: 24px;
      text-align: right;
      flex-shrink: 0;
    }
    .q-info { flex: 1; min-width: 0; }
    .q-title {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 1px;
    }
    .q-title a { color: var(--txt); text-decoration: none; }
    .q-title a:hover { color: var(--accent); }
    .q-meta-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--txt2);
    }
    .badge {
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      padding: 1px 5px;
      border-radius: 3px;
      text-transform: uppercase;
    }
    .badge-paid { background: color-mix(in srgb, var(--gold) 15%, transparent); color: var(--gold); }
    .badge-now  { background: color-mix(in srgb, var(--green) 15%, transparent); color: var(--green); }
    .q-dur { font-family: 'DM Mono', monospace; font-size: 0.7rem; color: var(--txt3); }
    .q-rm {
      opacity: 0;
      width: 22px; height: 22px;
      border-radius: 4px;
      border: 1px solid var(--border2);
      background: transparent;
      color: var(--txt2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.15s, border-color 0.15s, color 0.15s;
      flex-shrink: 0;
    }
    .q-item:hover .q-rm { opacity: 1; }
    .q-rm:hover { border-color: var(--red); color: var(--red); }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 120px;
      color: var(--txt3);
      font-size: 0.8rem;
      gap: 6px;
    }

    /* ── Form elements ── */
    .field-group { margin-bottom: 10px; }
    .field-label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--txt3);
      margin-bottom: 5px;
      display: block;
    }
    input[type=text] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      background: var(--surface2);
      color: var(--txt);
      font-size: 0.82rem;
      font-family: 'DM Sans', sans-serif;
      transition: border-color 0.15s;
      outline: none;
    }
    input[type=text]:focus { border-color: var(--accent); }
    input[type=text]::placeholder { color: var(--txt3); }

    .btn {
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--radius);
      border: 1px solid transparent;
      font-size: 0.82rem;
      font-weight: 500;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: opacity 0.15s, background 0.15s;
    }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--accent2); }
    .btn-ghost {
      background: transparent;
      border-color: var(--border2);
      color: var(--txt2);
    }
    .btn-ghost:hover:not(:disabled) { border-color: var(--border2); background: var(--surface3); color: var(--txt); }
    .btn-danger-ghost {
      background: transparent;
      border-color: var(--border2);
      color: var(--txt2);
    }
    .btn-danger-ghost:hover:not(:disabled) { border-color: var(--red); color: var(--red); }

    .divider { height: 1px; background: var(--border); margin: 14px 0; }

    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

    .pl-status-box {
      margin-top: 10px;
      padding: 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .pl-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      font-size: 0.75rem;
    }
    .pl-status-row:last-child { margin-bottom: 0; }
    .pl-status-key { color: var(--txt3); }
    .pl-status-val { color: var(--txt); font-family: 'DM Mono', monospace; font-size: 0.72rem; }
    .pl-status-val.active { color: var(--green); }

    .btn-group-gap { margin-top: 6px; }

    /* ── Playlist panel (slide-in) ── */
    .playlist-panel {
      width: 300px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
    }
    .playlist-panel.open {
      transform: translateX(0);
      position: relative;
    }
    .pl-panel-header {
      height: 44px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid var(--border);
      gap: 8px;
      flex-shrink: 0;
    }
    .pl-panel-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--txt3);
      flex: 1;
    }
    .pl-panel-count {
      font-size: 0.7rem;
      font-family: 'DM Mono', monospace;
      color: var(--txt2);
    }
    .pl-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--border2) transparent;
    }
    .pl-item {
      padding: 8px 10px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background 0.12s;
      border: 1px solid transparent;
      margin-bottom: 2px;
    }
    .pl-item:hover { background: var(--surface2); }
    .pl-item.active {
      background: color-mix(in srgb, var(--accent) 10%, var(--surface2));
      border-color: color-mix(in srgb, var(--accent) 25%, transparent);
    }
    .pl-item-title {
      font-size: 0.82rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .pl-item-dur { font-size: 0.68rem; color: var(--txt3); font-family: 'DM Mono', monospace; }
    .pl-item-num { color: var(--txt3); font-size: 0.65rem; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-logo">yt<span>player</span></div>
  <div class="header-sep"></div>
  <div class="conn-dot" id="connDot"></div>
  <div class="conn-label" id="connLabel">offline</div>
</div>

<div class="layout">

  <!-- Left sidebar -->
  <aside class="sidebar">
    <div class="sidebar-title">Controls</div>
    <div class="sidebar-body">

      <div class="field-group">
        <label class="field-label">Add track</label>
        <input type="text" id="url" placeholder="YouTube URL or video ID" style="margin-bottom:6px"/>
        <input type="text" id="user" placeholder="Username" value="User" style="margin-bottom:6px"/>
        <button class="btn btn-primary" onclick="api.add()" id="addBtn">Add to queue</button>
      </div>

      <div class="divider"></div>

      <div class="field-group">
        <label class="field-label">Fallback playlist</label>
        <input type="text" id="plUrl" placeholder="YouTube playlist URL" style="margin-bottom:6px"/>
        <button class="btn btn-ghost" onclick="api.plSet()" id="plSetBtn" style="margin-bottom:6px">Load playlist</button>
        <div class="btn-row">
          <button class="btn btn-ghost" onclick="api.plToggle(1)">Enable</button>
          <button class="btn btn-danger-ghost" onclick="api.plToggle(0)">Disable</button>
        </div>
        <div class="btn-row btn-group-gap">
          <button class="btn btn-ghost" onclick="api.plReload()" id="plReload">Reload</button>
          <button class="btn btn-ghost" onclick="api.plShuffle()" id="plShuffle">Shuffle</button>
        </div>
        <div class="pl-status-box" id="plStatusBox" style="display:none">
          <div class="pl-status-row">
            <span class="pl-status-key">Status</span>
            <span class="pl-status-val" id="plSt">—</span>
          </div>
          <div class="pl-status-row">
            <span class="pl-status-key">Tracks</span>
            <span class="pl-status-val" id="plTr">—</span>
          </div>
          <div class="pl-status-row">
            <span class="pl-status-key">Shuffle</span>
            <span class="pl-status-val" id="plShuffleStatus">Off</span>
          </div>
        </div>
      </div>

    </div>
  </aside>

  <!-- Center -->
  <main class="center">

    <div class="now-playing">
      <div class="np-thumb-placeholder" id="thumbPlaceholder">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M21 7L13 12L21 17V7Z" fill="currentColor" opacity=".5"/>
          <path d="M3 5H13V19H3V5Z" fill="currentColor" opacity=".3"/>
        </svg>
      </div>
      <img class="np-thumb" id="thumb" src="" alt=""/>
      <div class="np-info">
        <div class="np-eyebrow">Now playing</div>
        <div class="np-title" id="npTitle">—</div>
        <div class="np-by" id="npBy">—</div>
      </div>
      <div class="controls">
        <div class="ctrl" onclick="api.cmd('previous')" title="Previous">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none">
            <path d="M19 18V6L9 12L19 18ZM21 18V6H19V18H21Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="ctrl play-btn" id="ppBtn" onclick="api.pp()" title="Play / Pause">
          <svg id="ppIcon" width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
          </svg>
        </div>
        <div class="ctrl" onclick="api.cmd('next')" title="Next">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none">
            <path d="M5 18V6L15 12L5 18ZM3 18V6H5V18H3Z" fill="currentColor"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="queue-section">
      <div class="queue-header">
        <span class="queue-header-title">Queue</span>
        <div class="queue-stats">
          <span class="qstat"><span class="qstat-num" id="sPaid">0</span> paid</span>
          <span class="qstat-sep">·</span>
          <span class="qstat"><span class="qstat-num" id="sFree">0</span> free</span>
        </div>
        <div class="header-sep-flex"></div>
        <button class="btn-clear" onclick="api.cmd('clear')">Clear all</button>
      </div>

      <div class="queue-meta-bar">
        <div class="meta-item">
          <span class="meta-label">Played</span>
          <span class="meta-val" id="mPlayed">0</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Paid</span>
          <span class="meta-val" id="mPaid">0</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Playlist</span>
          <span class="meta-val" id="mPlaylist">0</span>
        </div>
        <div class="meta-item" style="margin-left:auto">
          <div class="meta-dot off" id="donDot"></div>
          <span class="meta-label" id="donLabel">Donations off</span>
        </div>
      </div>

      <div class="queue-list" id="qList">
        <div class="empty-state">Queue is empty</div>
      </div>
    </div>

  </main>

  <!-- Playlist panel -->
  <aside class="playlist-panel" id="plPanel">
    <div class="pl-panel-header">
      <span class="pl-panel-title">Playlist</span>
      <span class="pl-panel-count" id="plCount">0 tracks</span>
    </div>
    <div class="pl-list" id="plList"></div>
  </aside>

</div>

<script>
  let ws, currSt = 'stopped', reconnectAttempts = 0, reconnectTimer = null;
  const base = window.location.origin;

  const api = {
    async fetch(path, opts = {}) {
      try {
        const r = await fetch(base + path, opts);
        return await r.json();
      } catch (e) { return { success: false, message: e.message }; }
    },
    async add() {
      const u = document.getElementById('url').value.trim();
      const usr = document.getElementById('user').value.trim() || 'User';
      const btn = document.getElementById('addBtn');
      if (!u) return;
      btn.disabled = true; btn.textContent = 'Loading…';
      const d = await this.fetch(`/api/add-url?url=${encodeURIComponent(u)}&user=${encodeURIComponent(usr)}`, { method: 'POST' });
      btn.disabled = false; btn.textContent = 'Add to queue';
      if (d.success) document.getElementById('url').value = '';
      else alert(d.message);
    },
    async cmd(c) {
      const d = await this.fetch(`/api/${c}`, { method: 'POST' });
      if (!d.success) alert(d.message);
    },
    async pp() { await this.cmd(currSt === 'playing' ? 'pause' : 'play'); },
    async loadPlaylistTracks() {
      const d = await this.fetch('/api/playlist/tracks');
      if (d.success) ui.playlistTracks(d.data);
    },
    async plSet() {
      const u = document.getElementById('plUrl').value.trim();
      const btn = document.getElementById('plSetBtn');
      if (!u) return;
      btn.disabled = true; btn.textContent = 'Loading…';
      const d = await this.fetch(`/api/playlist/set?url=${encodeURIComponent(u)}`, { method: 'POST' });
      btn.disabled = false; btn.textContent = 'Load playlist';
      if (d.success) await this.loadPlaylistTracks();
      else alert(d.message);
    },
    async plToggle(e) {
      const d = await this.fetch(`/api/playlist/${e ? 'enable' : 'disable'}`, { method: 'POST' });
      if (d.success) { ui.playlist(d.data); await this.loadPlaylistTracks(); }
    },
    async plReload() {
      const btn = document.getElementById('plReload');
      btn.disabled = true; btn.textContent = 'Reloading…';
      const d = await this.fetch('/api/playlist/reload', { method: 'POST' });
      btn.disabled = false; btn.textContent = 'Reload';
      if (d.success) await this.loadPlaylistTracks();
      else alert(d.message);
    },
    async plJump(i) { await this.fetch(`/api/playlist/jump?index=${i}`, { method: 'POST' }); },
    async plShuffle() {
      const d = await this.fetch('/api/playlist/shuffle', { method: 'POST' });
      if (d.success) { ui.playlist(d.data); await this.loadPlaylistTracks(); }
    },
    async rm(i) { await this.fetch(`/api/remove?index=${i}`, { method: 'POST' }); },
  };

  const ui = {
    update(d) {
      currSt = d.action || 'stopped';
      const t = d.current;
      const titleEl = document.getElementById('npTitle');
      const byEl = document.getElementById('npBy');
      const thumb = document.getElementById('thumb');
      const placeholder = document.getElementById('thumbPlaceholder');
      const ppBtn = document.getElementById('ppBtn');
      const ppIcon = document.getElementById('ppIcon');

      if (t) {
        titleEl.innerHTML = `<a href="https://www.youtube.com/watch?v=${t.video_id}" target="_blank">${t.title}</a>`;
        byEl.textContent = t.added_by || 'Unknown';
        thumb.src = `https://img.youtube.com/vi/${t.video_id}/mqdefault.jpg`;
        thumb.classList.add('visible');
        placeholder.style.display = 'none';
      } else {
        titleEl.innerHTML = '—';
        byEl.textContent = '—';
        thumb.classList.remove('visible');
        placeholder.style.display = 'flex';
      }

      if (currSt === 'playing') {
        ppBtn.classList.remove('paused');
        ppIcon.innerHTML = '<path d="M14 19V5H18V19H14ZM6 19V5H10V19H6Z" fill="currentColor"/>';
      } else {
        ppBtn.classList.add('paused');
        ppIcon.innerHTML = '<path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>';
      }
    },

    queue(d) {
      const qu = d.queue || [];
      const pos = d.position || 0;
      const paid = qu.filter(t => t.is_paid).length;
      const free = qu.filter(t => !t.is_paid).length;
      const plTracks = qu.filter(t => t.added_by === 'Playlist').length;

      document.getElementById('sPaid').textContent = paid;
      document.getElementById('sFree').textContent = free;
      document.getElementById('mPlayed').textContent = pos;
      document.getElementById('mPaid').textContent = paid;
      document.getElementById('mPlaylist').textContent = plTracks;

      const list = document.getElementById('qList');
      if (qu.length === 0) {
        list.innerHTML = '<div class="empty-state">Queue is empty</div>';
        return;
      }

      list.innerHTML = qu.map((t, i) => {
        const isCur = i === pos;
        const isPast = i < pos;
        const isFut = i > pos;
        const qIdx = i - pos - 1;
        const m = Math.floor(t.duration_sec / 60);
        const s = (t.duration_sec % 60).toString().padStart(2, '0');
        const cls = [
          'q-item',
          isCur ? 'current' : '',
          t.is_paid ? 'paid' : (t.added_by === 'Playlist' ? 'playlist-track' : ''),
          isPast ? 'past' : ''
        ].filter(Boolean).join(' ');

        const badges = (t.is_paid ? '<span class="badge badge-paid">paid</span>' : '') +
                       (isCur ? '<span class="badge badge-now">now</span>' : '');
        const rmBtn = isFut
          ? `<button class="q-rm" onclick="api.rm(${qIdx})"><svg width="10" height="10" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>`
          : '';

        return `<div class="${cls}">
          <span class="q-num">${i + 1}</span>
          <div class="q-info">
            <div class="q-title"><a href="https://www.youtube.com/watch?v=${t.video_id}" target="_blank">${t.title}</a></div>
            <div class="q-meta-row">${badges}<span>${t.added_by || 'Unknown'}</span><span class="q-dur">${m}:${s}</span></div>
          </div>
          ${rmBtn}
        </div>`;
      }).join('');
    },

    playlist(d) {
      if (!d) return;
      const box = document.getElementById('plStatusBox');
      if (!d.loaded || d.total_tracks === 0) {
        box.style.display = 'none';
        return;
      }
      box.style.display = 'block';
      const stEl = document.getElementById('plSt');
      stEl.textContent = d.enabled ? 'Enabled' : 'Disabled';
      stEl.className = 'pl-status-val' + (d.enabled ? ' active' : '');
      document.getElementById('plTr').textContent = d.total_tracks;
      document.getElementById('plShuffleStatus').textContent = d.shuffled ? 'On' : 'Off';
    },

    playlistTracks(d) {
      if (!d) return;
      const tracks = d.tracks || [];
      const cur = d.current_index || 0;
      const panel = document.getElementById('plPanel');
      const list = document.getElementById('plList');
      const count = document.getElementById('plCount');

      count.textContent = tracks.length + ' tracks';

      if (tracks.length === 0) {
        panel.classList.remove('open');
        list.innerHTML = '';
        return;
      }

      panel.classList.add('open');
      list.innerHTML = tracks.map((t, i) => {
        const m = Math.floor(t.duration_sec / 60);
        const s = (t.duration_sec % 60).toString().padStart(2, '0');
        return `<div class="pl-item ${i === cur ? 'active' : ''}" onclick="api.plJump(${i})">
          <div class="pl-item-title"><span class="pl-item-num">${i + 1}. </span>${t.title}</div>
          <div class="pl-item-dur">${m}:${s}</div>
        </div>`;
      }).join('');
    },
  };

  function getReconnectDelay() {
    return Math.min(1000 * Math.pow(2, reconnectAttempts++), 30000);
  }

  function connect() {
    ws = new WebSocket('ws://' + location.host + '/ws');
    ws.onopen = () => {
      reconnectAttempts = 0;
      if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
      document.getElementById('connDot').classList.add('on');
      document.getElementById('connLabel').textContent = 'online';
      api.fetch('/api/playlist/status').then(d => { if (d.success) ui.playlist(d.data); });
      api.loadPlaylistTracks();
    };
    ws.onmessage = e => {
      try {
        const d = JSON.parse(e.data);
        ui.update(d);
        ui.queue(d);
        ui.playlist(d.playlist);
      } catch (_) {}
    };
    ws.onclose = () => {
      document.getElementById('connDot').classList.remove('on');
      reconnectTimer = setTimeout(() => {
        document.getElementById('connLabel').textContent = 'reconnecting…';
      }, 2000);
      setTimeout(connect, getReconnectDelay());
    };
    ws.onerror = () => {};
  }

  window.addEventListener('load', async () => {
    connect();
    const don = await api.fetch('/api/donation/status');
    if (don.success) {
      const dot = document.getElementById('donDot');
      const lbl = document.getElementById('donLabel');
      if (don.data.enabled) { dot.classList.remove('off'); lbl.textContent = 'Donations active'; }
      else { dot.classList.add('off'); lbl.textContent = 'Donations off'; }
    }
    document.addEventListener('keydown', e => {
      if (e.target.matches('input,textarea,select,[contenteditable]')) return;
      if (e.code === 'Space')      { e.preventDefault(); api.pp(); }
      else if (e.code === 'ArrowRight') { e.preventDefault(); api.cmd('next'); }
      else if (e.code === 'ArrowLeft')  { e.preventDefault(); api.cmd('previous'); }
    });
  });
</script>
</body>
</html>